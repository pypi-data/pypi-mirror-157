"use strict";(self.webpackChunkjupyterlab_nbsafety=self.webpackChunkjupyterlab_nbsafety||[]).push([[568],{568:(e,t,n)=>{n.r(t),n.d(t,{default:()=>T});var l=n(337),s=n(503);const o="nbsafety",d={id:"jupyterlab-nbsafety",requires:[s.INotebookTracker],autoStart:!0,activate:(e,t)=>{t.widgetAdded.connect(((e,t)=>{const n=t.sessionContext;n.ready.then((()=>{I(t.content),w=t.content.activeCell,p=t.content.activeCell.model.id;let e=()=>{};n.session.kernel.name===o&&(e=N(n,t.content)),n.kernelChanged.connect(((l,s)=>{I(t.content),e(),e=()=>{},null!==s.newValue&&s.newValue.name===o&&(e=N(n,t.content))}));let l=!1;n.statusChanged.connect(((n,s)=>{"restarting"!==s&&"autorestarting"!==s||(l=!0),"idle"!==s&&"busy"!==s||!l||(l=!1,n.ready.then((()=>{I(t.content),e(),e=()=>{},n.session.kernel.name===o&&(e=N(n,t.content))})))}))}))}))}},a="stale-cell",c="fresh-cell",i="refresher-cell",r="refresher-input-cell",u="linked-stale",m="linked-refresher";let h=new Set,f=new Set,v=new Set,_={},C={},w=null,p=null,y={},E={},L=null,g=null,b=null,S=new Set,k=new Set,x=new Set;const j=new Event("cleanup"),D=e=>{if(null==e)return null;const t=e.children.item(1);return null===t?null:t.firstElementChild},O=e=>{if(null==e)return null;const t=e.children.item(2);return null===t?null:t.firstElementChild},V=(e,t,n)=>{const l=()=>{e.removeEventListener(t,n),e.removeEventListener("cleanup",l)};e.addEventListener(t,n),e.addEventListener("cleanup",l)},P=(e,t,n,l,s)=>{null!==e&&null!==t&&V(e,n,(()=>{t.firstElementChild.classList[l](s)}))},q=(e,t)=>{P(D(e),O(e),"mouseover","add",u),P(D(e),O(e),"mouseout","remove",u),P(O(e),D(e),"mouseover","add",t),P(O(e),D(e),"mouseout","remove",t)},A=e=>{y={},E={},e.widgets.forEach(((e,t)=>{y[e.model.id]=e.node,E[e.model.id]=t}))},I=e=>{e.widgets.forEach(((e,t)=>{e.node.classList.remove(a),e.node.classList.remove(i),e.node.classList.remove(c),e.node.classList.remove(r);const n=D(e.node);null!==n&&(n.firstElementChild.classList.remove(u),n.firstElementChild.classList.remove(m),n.dispatchEvent(j));const l=O(e.node);null!==l&&(l.firstElementChild.classList.remove(u),l.firstElementChild.classList.remove(m),l.dispatchEvent(j))}))},M=(e,t,n,l,s,o,d)=>{if(null===e)return;const a=()=>{for(const e of t){let t=m;d.has(e)&&(t=u);const s=l(n[e]);if(null===s||null===s.firstElementChild)return;s.firstElementChild.classList[o](t)}};e.addEventListener(s,a),V(e,s,a)},N=(e,t)=>{const n=e.session.kernel.createComm("nbsafety");let s=!1;const o=(d,a)=>{if(s)return void d.stateChanged.disconnect(o);if("executionCount"!==a.name||null===a.newValue)return;const i={};t.widgets.forEach(((e,t)=>{i[e.model.id]=t,e.model.id===d.id&&(e.node.classList.remove(c),e.node.classList.remove(r))}));const u={type:"cell_freshness",executed_cell_id:d.id,order_index_by_cell_id:i};n.send(u).done.then((()=>{null!==L?l.CodeCell.execute(L,e):("reactive"===g&&(v=S,P(t)),k=new Set,x=new Set,S=new Set,n.send({type:"reactivity_cleanup"}))}))},d=e=>{let l=-1;t.widgets.forEach(((t,n)=>{t.model.id===e.id&&(l=n)}));const s={type:"change_active_cell",active_cell_id:e.id,active_cell_order_idx:l};n.send(s)},E=(e,n)=>{if(t===e)if(s)t.activeCellChanged.disconnect(E);else if(d(n.model),null!==w&&null!==w.model&&(w.model.isDirty?h.add(p):h.delete(p),w.model.stateChanged.disconnect(o,w.model.stateChanged)),w=n,p=n.model.id,null!==w&&null!==w.model&&"code"===w.model.type){if(w.model.stateChanged.connect(o),d(w.model),h.has(p)){const e=w.model;void 0!==e._setDirty&&e._setDirty(!0)}A(t),V(p)}};t.activeCellChanged.connect(E);const j=[{action:"mouseover",update:"add"},{action:"mouseout",update:"remove"}],V=e=>{const t=y[e];f.has(e)?(t.classList.add(a),t.classList.add(c),t.classList.remove(r),q(t,u)):v.has(e)&&(t.classList.add(r),"normal"===g&&(t.classList.add(c),q(t,m))),"reactive"!==g&&(_.hasOwnProperty(e)&&j.forEach((({action:n,update:l})=>{M(D(t),_[e],y,D,n,l,f),M(O(t),_[e],y,D,n,l,f)})),C.hasOwnProperty(e)&&(f.has(e)||(t.classList.add(i),t.classList.add(c)),j.forEach((({action:n,update:l})=>{M(D(t),C[e],y,D,n,l,f),M(D(t),C[e],y,O,n,l,f)}))))},P=e=>{if(I(e),b){A(e);for(const[e]of Object.entries(y))V(e)}};return n.onMsg=e=>{if(!s)if("establish"===e.content.data.type)t.activeCell.model.stateChanged.connect(o),d(t.activeCell.model);else if("cell_freshness"===e.content.data.type){f=new Set(e.content.data.stale_cells),v=new Set(e.content.data.fresh_cells),k=new Set([...k,...e.content.data.new_fresh_cells]),x=new Set([...x,...e.content.data.forced_reactive_cells]),_=e.content.data.stale_links,C=e.content.data.refresher_links,L=null;const n=e.content.data.exec_mode,l=e.content.data.flow_order,s=e.content.data.exec_schedule;g=n,b=e.content.data.highlights_enabled,S.add(e.content.data.last_executed_cell_id);let o=!1;t.widgets.forEach((e=>{if(!o&&"code"===e.model.type&&!S.has(e.model.id)&&("reactive"===n&&k.has(e.model.id)||x.has(e.model.id))){const t=e;null===L?(L=t,o="in_order"===l||"strict"===s):null!==t.model.executionCount&&t.model.executionCount<L.model.executionCount&&(L=t)}})),null===L?(k=new Set,x=new Set,P(t)):I(t)}},n.open({}),()=>{s=!0}},T=d}}]);