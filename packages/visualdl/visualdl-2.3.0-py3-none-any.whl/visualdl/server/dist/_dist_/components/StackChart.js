import*as nt from"../utils/chart.js";import _,{useCallback as h,useEffect as L,useImperativeHandle as yt,useMemo as S,useRef as X,useState as W}from"../../__snowpack__/pkg/react.js";import{primaryColor as vt,transitionProps as kt}from"../utils/style.js";import _t,{Wrapper as bt,useChartTheme as Pt}from"../hooks/useECharts.js";import Ot from"../../__snowpack__/pkg/react-spinners/GridLoader.js";import Tt from"../../__snowpack__/pkg/lodash/defaultsDeep.js";import jt from"../../__snowpack__/pkg/styled-components.js";import zt from"../hooks/useThrottleFn.js";const Et=jt.div`
    position: absolute;
    z-index: 1;
    background-color: var(--tooltip-background-color);
    color: var(--tooltip-text-color);
    border-radius: 4px;
    padding: 5px;
    display: none;
    ${kt(["color","background-color"])}
`,Lt=_.forwardRef(({options:b,data:A,title:P,loading:it,zoom:lt,className:at,onInit:$},ct)=>{var et,ot;const{minZ:I,maxZ:H,minY:c,maxY:d,minX:G,maxX:q,...B}=A!=null?A:{minZ:0,maxZ:0,minY:0,maxY:0,minX:0,maxX:0,data:null},g=S(()=>{var t;return(t=B.data)!=null?t:[]},[B.data]),x=S(()=>c===0&&d===0?-.4:c-(d-c)*.4,[c,d]),y=h((t,e,n,r)=>{const o=r([t,e]);return o?(o[1]-=(n-I)/(H-I)*(r([0,c])[1]-r([0,x])[1]),o):[0,0]},[I,H,c,x]),F=h((t,e,n)=>{const r=[];let o=0;for(;g[t]&&o<g[t].length;){const s=e(o++),m=e(o++),p=e(o++);p!==1&&o===3&&r.push(y(s,m,1,n)),r.push(y(s,m,p,n)),p!==1&&o===g[t].length&&r.push(y(s,m,1,n))}return r},[y,g]),J=h((t,e)=>{var r,o;const n=F(t.dataIndex,e.value,e.coord);return{type:"polygon",silent:!0,z:(r=e.value)==null?void 0:r.call(e,1),shape:{points:n},style:(o=e.style)==null?void 0:o.call(e,{stroke:nt.xAxis.axisLine.lineStyle.color,lineWidth:1})}},[F]),[f,K]=W(null),[v,N]=W([]),u=X(null),[pt,Q]=W(""),Z=X(f),U=X(v);L(()=>{Z.current=f},[f]),L(()=>{U.current=v},[v]);const O=(ot=(et=b==null?void 0:b.axisPointer)==null?void 0:et.label)==null?void 0:ot.formatter,V=h(t=>!O||Z.current==null?"":typeof O=="string"?O:O(t,U.current[Z.current]),[O]),tt=Pt(),a=S(()=>{const{color:t,colorAlt:e,toolbox:n,series:r,...o}=nt;return Tt({title:{text:P!=null?P:""},visualMap:{min:c,max:d},axisPointer:{label:{formatter:V}},xAxis:{min:G,max:q,axisPointer:{type:"none"}},yAxis:{inverse:!0,position:"right",min:x,max:d,axisLine:{onZero:!1},axisLabel:{formatter:s=>s<c?"":s+""},axisPointer:{type:"none"}},grid:{left:o.grid.right,right:o.grid.left},tooltip:{trigger:"none",showContent:!1,axisPointer:{axis:"y",snap:!1}},series:[{...r,type:"custom",silent:!0,data:g,renderItem:J}]},b,tt,o)},[b,P,tt,g,G,q,c,d,x,J,V]),T=h(()=>{var t;K(null),N([]),((t=a.tooltip)==null?void 0:t.formatter)&&(Q(""),u.current&&(u.current.style.display="none"))},[a.tooltip]),ut=h((t,e)=>{var n,r,o,s,m;try{if(!t||!e)return;const{offsetX:p,offsetY:k}=e;if(k<x+a.grid.top){T();return}const[gt,xt]=t.convertFromPixel("grid",[p,k]),w=(r=(n=t.getOption().series)==null?void 0:n[0].data)!=null?r:[],C=w.map(l=>l[1]).sort((l,z)=>l-z);let D=0,j=null;for(;D<C.length;)if(xt<=C[D++]){j=C[D-1];break}const M=j==null?null:w.findIndex(l=>l[1]===j);K(M);let Y=[];j==null||(Y=w.map(l=>{const z=[l[0],l[1],l[2]];let rt=Number.POSITIVE_INFINITY;for(let E=0;E<l.length;E+=3){const st=Math.abs(l[E]-gt);st<rt&&(rt=st,z[0]=l[E],z[2]=l[E+2])}return z})),N(Y),((o=a.tooltip)==null?void 0:o.formatter)&&(Q(M==null?"":(m=(s=a.tooltip)==null?void 0:s.formatter)==null?void 0:m.call(s,Y[M])),u.current&&(j==null?u.current.style.display="none":(u.current.style.left=`${p+10}px`,u.current.style.top=`${k+10}px`,u.current.style.display="block")))}catch{T()}},[T,x,a.grid,a.tooltip]),R=zt(ut,{wait:200}),mt=h(t=>{try{const e=t.getZr();e&&(e.on("mousemove",n=>R.run(t,n)),e.on("mouseout",()=>{R.cancel(),T()}))}catch{R.cancel()}$==null||$(t)},[$,R,T]),{ref:ft,echart:i,wrapper:ht,saveAsImage:dt}=_t({loading:!!it,zoom:lt,autoFit:!0,onInit:mt});return yt(ct,()=>({saveAsImage:()=>{dt(P)}})),L(()=>{i==null||i.setOption(a,{notMerge:!0})},[i,a]),L(()=>{var t,e;if(i)try{if(f==null)i.setOption({graphic:{elements:[{id:"highlight",type:"polyline",$action:"remove"}]}});else{const n=(e=(t=i.getOption().series)==null?void 0:t[0].data)!=null?e:[],r=s=>i.convertToPixel("grid",s),o=s=>n[f][s];i.setOption({graphic:{elements:[{id:"highlight",type:"polyline",$action:"replace",silent:!0,cursor:"default",zlevel:1,z:1,shape:{points:F(f,o,r)}}]}})}}catch{}},[f,i,F]),L(()=>{var t,e,n,r;if(i)try{if(!v.length)i.setOption({graphic:{elements:(r=(n=(e=(t=i.getOption())==null?void 0:t.graphic)==null?void 0:e[0])==null?void 0:n.elements)==null?void 0:r.filter(o=>o.id.startsWith("dot")).map(o=>({id:o.id,type:"circle",$action:"remove"}))}});else{const o=s=>i.convertToPixel("grid",s);i.setOption({graphic:{elements:v.map((s,m)=>{var k;const p=y(s[0],s[1],s[2],o);return{type:"circle",id:`dot${m}`,$action:"replace",cursor:"default",zlevel:1,z:2,shape:{cx:p[0],cy:p[1],r:3},style:{fill:"#fff",stroke:(k=a.color)==null?void 0:k[0],lineWidth:2}}})}})}}catch{}},[v,i,a.color,y]),_.createElement(bt,{ref:ht,className:at},!i&&_.createElement("div",{className:"loading"},_.createElement(Ot,{color:vt,size:"10px"})),_.createElement("div",{className:"echarts",ref:ft}),_.createElement(Et,{className:"tooltip",ref:u,dangerouslySetInnerHTML:{__html:pt}}))});export default Lt;
